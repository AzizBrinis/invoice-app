generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String?
  role         UserRole  @default(VIEWER)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  sessions     Session[]
  companySettings   CompanySettings?
  messagingSettings MessagingSettings?
  messagingEmails   MessagingEmail[]
  clients           Client[]
  products          Product[]
  quotes            Quote[]
  invoices          Invoice[]
  payments          Payment[]
  invoiceAuditLogs  InvoiceAuditLog[]
  emailLogs         EmailLog[]
  numberingSequences NumberingSequence[]
  spamDetectionLogs SpamDetectionLog[]
  spamSenderReputations SpamSenderReputation[]
  savedResponses MessagingSavedResponse[]
  autoReplyLogs MessagingAutoReplyLog[]
  scheduledEmails MessagingScheduledEmail[]
  messagingInboxSyncState MessagingInboxSyncState?
  websiteConfig WebsiteConfig?
}

enum UserRole {
  ADMIN
  ACCOUNTANT
  VIEWER
}

model Session {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model CompanySettings {
  id                     String         @id @default(cuid())
  userId                 String         @unique
  user                   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName            String
  logoUrl                String?
  logoData               String?
  matriculeFiscal        String?
  tvaNumber              String?
  address                String?
  email                  String?
  phone                  String?
  iban                   String?
  stampImage             String?
  signatureImage         String?
  stampPosition          String         @default("bottom-right")
  signaturePosition      String         @default("bottom-right")
  defaultCurrency        String         @default("TND")
  defaultVatRate         Float          @default(0)
  paymentTerms           String?
  invoiceNumberPrefix    String         @default("FAC")
  quoteNumberPrefix      String         @default("DEV")
  resetNumberingAnnually Boolean        @default(true)
  defaultInvoiceFooter   String?
  defaultQuoteFooter     String?
  legalFooter            String?
  defaultConditions      String?
  invoiceTemplateId      String?
  quoteTemplateId        String?
  taxConfiguration       Json?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  invoiceTemplate        PdfTemplate?   @relation("InvoiceTemplate", fields: [invoiceTemplateId], references: [id])
  quoteTemplate          PdfTemplate?   @relation("QuoteTemplate", fields: [quoteTemplateId], references: [id])
}

model WebsiteConfig {
  id                      String             @id @default(cuid())
  userId                  String             @unique
  user                    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  slug                    String             @unique
  templateKey             String             @default("dev-agency")
  previewToken            String             @unique @default(cuid())
  heroEyebrow             String?
  heroTitle               String             @default("Découvrez nos solutions")
  heroSubtitle            String?
  heroPrimaryCtaLabel     String?            @default("Demander un devis")
  heroSecondaryCtaLabel   String?            @default("Télécharger la plaquette")
  heroSecondaryCtaUrl     String?
  aboutTitle              String?
  aboutBody               String?
  contactBlurb            String?
  contactEmailOverride    String?
  contactPhoneOverride    String?
  contactAddressOverride  String?
  seoTitle                String?
  seoDescription          String?
  seoKeywords             String?
  socialImageUrl          String?
  socialLinks             Json?
  theme                   WebsiteThemeMode   @default(SYSTEM)
  accentColor             String             @default("#2563eb")
  showPrices              Boolean            @default(true)
  showInactiveProducts    Boolean            @default(false)
  featuredProductIds      Json?
  leadNotificationEmail   String?
  leadAutoTag             String?
  leadThanksMessage       String?
  spamProtectionEnabled   Boolean            @default(true)
  builderConfig           Json               @default("{}")
  builderVersionHistory   Json               @default("[]")
  customDomain            String?            @unique
  domainStatus            WebsiteDomainStatus @default(PENDING)
  domainVerificationCode  String             @unique @default(cuid())
  domainVerifiedAt        DateTime?
  domainActivatedAt       DateTime?
  published               Boolean            @default(false)
  previewPath             String             @default("catalogue")
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
}

model MessagingSettings {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromEmail         String?
  senderName        String?
  senderLogoUrl     String?
  imapHost          String?
  imapPort          Int?
  imapSecure        Boolean  @default(true)
  imapUser          String?
  imapPassword      String?
  smtpHost          String?
  smtpPort          Int?
  smtpSecure        Boolean  @default(true)
  smtpUser          String?
  smtpPassword      String?
  spamFilterEnabled Boolean  @default(true)
  trackingEnabled   Boolean  @default(true)
  autoReplyEnabled        Boolean  @default(false)
  autoReplySubject        String?
  autoReplyBody           String?
  vacationModeEnabled     Boolean  @default(false)
  vacationSubject         String?
  vacationMessage         String?
  vacationStartDate       DateTime?
  vacationEndDate         DateTime?
  vacationBackupEmail     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model MessagingInboxSyncState {
  userId               String  @id
  user                 User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastInboxAutoReplyUid Int?
  lastInboxSyncAt      DateTime?
  lastAutoReplyAt      DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

enum SavedResponseFormat {
  PLAINTEXT
  HTML
}

model MessagingSavedResponse {
  id        String               @id @default(cuid())
  userId    String
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  slug      String?
  description String?
  content   String
  format    SavedResponseFormat  @default(PLAINTEXT)
  builtIn   Boolean              @default(false)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@index([userId, title])
  @@unique([userId, slug])
}

enum MessagingRecipientType {
  TO
  CC
  BCC
}

enum MessagingEventType {
  OPEN
  CLICK
}

enum MessagingScheduledStatus {
  PENDING
  SENDING
  SENT
  FAILED
  CANCELLED
}

enum MessagingAutoReplyType {
  STANDARD
  VACATION
}

enum BackgroundJobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
  CANCELLED
}

enum BackgroundJobEventType {
  ENQUEUED
  DEDUPED
  STARTED
  SUCCEEDED
  FAILED
  RETRY_SCHEDULED
}

enum WebsiteDomainStatus {
  PENDING
  VERIFIED
  ACTIVE
}

enum WebsiteThemeMode {
  SYSTEM
  LIGHT
  DARK
}

model MessagingAutoReplyLog {
  id              String                  @id @default(cuid())
  userId          String
  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  senderEmail     String
  replyType       MessagingAutoReplyType
  originalMessageId String?
  originalUid     Int?
  sentAt          DateTime                @default(now())
  createdAt       DateTime                @default(now())

  @@index([userId, senderEmail])
  @@index([userId, sentAt])
}

model MessagingScheduledEmail {
  id          String                   @id @default(cuid())
  userId      String
  user        User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  to          Json
  cc          Json?
  bcc         Json?
  subject     String
  text        String
  html        String
  previewText String
  sendAt      DateTime
  sentAt      DateTime?
  canceledAt  DateTime?
  status      MessagingScheduledStatus @default(PENDING)
  failureReason String?
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  attachments MessagingScheduledAttachment[]

  @@index([userId, status, sendAt])
  @@index([status, sendAt])
}

model MessagingScheduledAttachment {
  id               String                  @id @default(cuid())
  scheduledEmailId String
  scheduledEmail   MessagingScheduledEmail @relation(fields: [scheduledEmailId], references: [id], onDelete: Cascade)
  filename         String?
  contentType      String?
  size             Int
  content          Bytes
  createdAt        DateTime                @default(now())

  @@index([scheduledEmailId])
}

model MessagingEmail {
  id              String                     @id @default(cuid())
  userId          String
  user            User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  messageId       String
  subject         String?
  sentAt          DateTime
  trackingEnabled Boolean                    @default(false)
  senderSessionHash String?
  senderIpHash     String?
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  recipients      MessagingEmailRecipient[]
  links           MessagingEmailLink[]
  events          MessagingEmailEvent[]

  @@unique([userId, messageId])
  @@index([userId, sentAt])
}

model MessagingEmailRecipient {
  id             String                       @id @default(cuid())
  emailId        String
  email          MessagingEmail               @relation(fields: [emailId], references: [id], onDelete: Cascade)
  address        String
  name           String?
  type           MessagingRecipientType
  openToken      String                       @unique
  openCount      Int                          @default(0)
  firstOpenedAt  DateTime?
  lastOpenedAt   DateTime?
  clickCount     Int                          @default(0)
  lastClickedAt  DateTime?
  createdAt      DateTime                     @default(now())
  updatedAt      DateTime                     @updatedAt
  linkRecipients MessagingEmailLinkRecipient[]
  events         MessagingEmailEvent[]

  @@index([emailId, address])
}

model MessagingEmailLink {
  id        String                 @id @default(cuid())
  emailId   String
  email     MessagingEmail         @relation(fields: [emailId], references: [id], onDelete: Cascade)
  url       String
  position  Int
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
  recipients MessagingEmailLinkRecipient[]
  events    MessagingEmailEvent[]

  @@index([emailId])
}

model MessagingEmailLinkRecipient {
  id             String                     @id @default(cuid())
  linkId         String
  link           MessagingEmailLink         @relation(fields: [linkId], references: [id], onDelete: Cascade)
  recipientId    String
  recipient      MessagingEmailRecipient    @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  token          String                     @unique
  clickCount     Int                        @default(0)
  firstClickedAt DateTime?
  lastClickedAt  DateTime?
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt
  events         MessagingEmailEvent[]

  @@index([linkId])
  @@index([recipientId])
}

model MessagingEmailEvent {
  id               String                      @id @default(cuid())
  emailId          String
  email            MessagingEmail              @relation(fields: [emailId], references: [id], onDelete: Cascade)
  recipientId      String?
  recipient        MessagingEmailRecipient?    @relation(fields: [recipientId], references: [id], onDelete: SetNull)
  linkId           String?
  link             MessagingEmailLink?         @relation(fields: [linkId], references: [id], onDelete: SetNull)
  linkRecipientId  String?
  linkRecipient    MessagingEmailLinkRecipient? @relation(fields: [linkRecipientId], references: [id], onDelete: SetNull)
  type             MessagingEventType
  userAgent        String?
  deviceFamily     String?
  deviceType       String?
  occurredAt       DateTime                    @default(now())
  createdAt        DateTime                    @default(now())

  @@index([emailId, occurredAt])
  @@index([recipientId])
  @@index([linkRecipientId])
}

model BackgroundJob {
  id             String             @id @default(cuid())
  type           String
  payload        Json?
  dedupeKey      String?
  priority       Int                @default(0)
  runAt          DateTime           @default(now())
  status         BackgroundJobStatus @default(PENDING)
  attempts       Int                @default(0)
  maxAttempts    Int                @default(5)
  retryBackoffMs Int                @default(60000)
  lastError      String?
  lockedAt       DateTime?
  lastRunAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  events         BackgroundJobEvent[]

  @@index([status, runAt])
  @@index([runAt])
  @@unique([type, dedupeKey])
}

model BackgroundJobEvent {
  id        String                @id @default(cuid())
  jobId     String
  job       BackgroundJob         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  type      BackgroundJobEventType
  detail    Json?
  createdAt DateTime              @default(now())

  @@index([jobId, createdAt])
}

model SpamDetectionLog {
  id             Int      @id @default(autoincrement())
  messageId      String?
  mailbox        String
  targetMailbox  String?
  uid            Int
  subject        String?
  sender         String?
  score          Int
  threshold      Int
  reasons        Json?
  autoMoved      Boolean  @default(false)
  manual         Boolean  @default(false)
  actor          String?
  detectedAt     DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, mailbox])
}

model SpamSenderReputation {
  id             Int      @id @default(autoincrement())
  userId         String
  domain         String
  spamCount      Int      @default(0)
  hamCount       Int      @default(0)
  lastFeedbackAt DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, domain])
  @@index([userId])
}

model PdfTemplate {
  id        String            @id @default(cuid())
  type      PdfTemplateType
  name      String
  content   Json
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  invoice   CompanySettings[] @relation("InvoiceTemplate")
  quote     CompanySettings[] @relation("QuoteTemplate")
}

enum PdfTemplateType {
  DEVIS
  FACTURE
}

model Client {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  displayName  String
  companyName  String?
  address      String?
  email        String?
  phone        String?
  vatNumber    String?
  notes        String?
  isActive     Boolean   @default(true)
  source       ClientSource @default(MANUAL)
  leadMetadata Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  quotes       Quote[]
  invoices     Invoice[]

  @@index([userId, displayName])
}

enum ClientSource {
  MANUAL
  IMPORT
  WEBSITE_LEAD
}

model Product {
  id                   String        @id @default(cuid())
  userId               String
  user                 User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sku                  String
  name                 String
  description          String?
  category             String?
  unit                 String        @default("unité")
  priceHTCents         Int
  priceTTCCents        Int
  vatRate              Float
  defaultDiscountRate  Float?
  isActive             Boolean       @default(true)
  isListedInCatalog    Boolean       @default(true)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  quoteLines           QuoteLine[]
  invoiceLines         InvoiceLine[]

  @@unique([userId, sku])
  @@index([userId, name])
}

model Quote {
  id                        String        @id @default(cuid())
  userId                    String
  user                      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  number                    String
  status                    QuoteStatus   @default(BROUILLON)
  reference                 String?
  issueDate                 DateTime
  validUntil                DateTime?
  clientId                  String
  client                    Client        @relation(fields: [clientId], references: [id])
  currency                  String        @default("TND")
  globalDiscountRate        Float?
  globalDiscountAmountCents Int?
  vatBreakdown              Json?
  taxSummary                Json?
  taxConfiguration          Json?
  notes                     String?
  terms                     String?
  subtotalHTCents           Int
  totalDiscountCents        Int
  totalTVACents             Int
  totalTTCCents             Int
  fodecAmountCents          Int           @default(0)
  timbreAmountCents         Int           @default(0)
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
  lines                     QuoteLine[]
  invoice                   Invoice?

  @@unique([userId, number])
  @@index([userId, status])
  @@index([userId, clientId])
  @@index([userId, issueDate, id])
  @@index([userId, number])
  @@index([userId, reference])
}

enum QuoteStatus {
  BROUILLON
  ENVOYE
  ACCEPTE
  REFUSE
  EXPIRE
}

model QuoteLine {
  id                   String   @id @default(cuid())
  quoteId              String
  productId            String?
  description          String
  quantity             Float
  unit                 String   @default("unité")
  unitPriceHTCents     Int
  vatRate              Float
  discountRate         Float?
  discountAmountCents  Int?
  totalHTCents         Int
  totalTVACents        Int
  totalTTCCents        Int
  fodecRate            Float?
  fodecAmountCents     Int?
  position             Int
  quote                Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product              Product? @relation(fields: [productId], references: [id])
}

model Invoice {
  id                        String         @id @default(cuid())
  userId                    String
  user                      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  number                    String
  status                    InvoiceStatus  @default(BROUILLON)
  reference                 String?
  issueDate                 DateTime
  dueDate                   DateTime?
  clientId                  String
  client                    Client         @relation(fields: [clientId], references: [id])
  currency                  String         @default("TND")
  globalDiscountRate        Float?
  globalDiscountAmountCents Int?
  vatBreakdown              Json?
  taxSummary                Json?
  taxConfiguration          Json?
  notes                     String?
  terms                     String?
  lateFeeRate               Float?
  subtotalHTCents           Int
  totalDiscountCents        Int
  totalTVACents             Int
  totalTTCCents             Int
  amountPaidCents           Int            @default(0)
  fodecAmountCents          Int            @default(0)
  timbreAmountCents         Int            @default(0)
  createdAt                 DateTime       @default(now())
  updatedAt                 DateTime       @updatedAt
  quoteId                   String?        @unique
  quote                     Quote?         @relation(fields: [quoteId], references: [id])
  lines                     InvoiceLine[]
  payments                  Payment[]

  @@unique([userId, number])
  @@index([userId, issueDate(sort: Desc), id(sort: Desc)], map: "Invoice_userId_issueDate_idx")
  @@index([userId, status, issueDate(sort: Desc), id(sort: Desc)], map: "Invoice_userId_status_issueDate_idx")
  @@index([userId, clientId, issueDate(sort: Desc), id(sort: Desc)], map: "Invoice_userId_clientId_issueDate_idx")
  @@index([userId, dueDate, id(sort: Desc)], map: "Invoice_userId_dueDate_idx")
}

enum InvoiceStatus {
  BROUILLON
  ENVOYEE
  PAYEE
  PARTIELLE
  RETARD
  ANNULEE
}

enum InvoiceAuditAction {
  CANCELLATION
  DELETION
}

model InvoiceLine {
  id                   String    @id @default(cuid())
  invoiceId            String
  productId            String?
  description          String
  quantity             Float
  unit                 String    @default("unité")
  unitPriceHTCents     Int
  vatRate              Float
  discountRate         Float?
  discountAmountCents  Int?
  totalHTCents         Int
  totalTVACents        Int
  totalTTCCents        Int
  fodecRate            Float?
  fodecAmountCents     Int?
  position             Int
  invoice              Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product              Product?  @relation(fields: [productId], references: [id])
}

model Payment {
  id             String   @id @default(cuid())
  invoiceId      String
  userId         String
  amountCents    Int
  method         String?
  date           DateTime
  note           String?
  createdAt      DateTime @default(now())
  invoice        Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model InvoiceAuditLog {
  id             String               @id @default(cuid())
  invoiceId      String
  userId         String
  action         InvoiceAuditAction
  previousStatus InvoiceStatus?
  newStatus      InvoiceStatus?
  note           String?
  createdAt      DateTime             @default(now())
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, invoiceId])
}

model NumberingSequence {
  id        String       @id @default(cuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      SequenceType
  prefix    String
  year      Int
  counter   Int          @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([userId, type, year])
  @@index([userId])
}

enum SequenceType {
  DEVIS
  FACTURE
}

model EmailLog {
  id           String       @id @default(cuid())
  userId       String
  documentType DocumentType
  documentId   String
  to           String
  subject      String
  body         String?
  sentAt       DateTime?
  status       EmailStatus  @default(EN_ATTENTE)
  error        String?
  createdAt    DateTime     @default(now())
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, documentType])
}

enum DocumentType {
  DEVIS
  FACTURE
}

enum EmailStatus {
  EN_ATTENTE
  ENVOYE
  ECHEC
}
